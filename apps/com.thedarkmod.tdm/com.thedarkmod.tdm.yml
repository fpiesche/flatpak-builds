app-id: com.thedarkmod.tdm
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '24.08'
sdk: org.freedesktop.Sdk
command: com.thedarkmod.tdm.sh

finish-args:
  # hardware 3D and gamepads
  - --device=all
  # Audio
  - --socket=pulseaudio
  # desktop
  - --share=ipc
  - --socket=x11
  # network for installation and map downloads
  - --share=network

add-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    directory: lib/ffmpeg
    add-ld-path: .

modules:
  - name: tdm
    buildsystem: simple
    sources:
      - type: script
        dest-filename: com.thedarkmod.tdm.sh
        commands:
          # Run installer if necessary
          - |
            if [[ ! -f $XDG_DATA_HOME/tdm/.installed ]]; then
              mkdir -p $XDG_DATA_HOME/tdm
              if [[ ! -f $XDG_DATA_HOME/tdm/tdm_installer.linux64 ]]; then
                cp /app/bin/tdm_installer.linux64 $XDG_DATA_HOME/tdm/
              fi
              cd $XDG_DATA_HOME/tdm
              ./tdm_installer.linux64 --unattended && rm *.exe *.ico && touch $XDG_DATA_HOME/tdm/.installed
            fi
          - cd $XDG_DATA_HOME/tdm && $XDG_DATA_HOME/tdm/thedarkmod.x64
      - type: script
        dest-filename: com.thedarkmod.tdm.installer.sh
        commands:
          - mkdir -p $XDG_DATA_HOME/tdm
          - cd $XDG_DATA_HOME/tdm
          - |
            if [[ ! -f $XDG_DATA_HOME/tdm/tdm_installer.linux64 ]]; then
              cp /app/bin/tdm_installer.linux64 $XDG_DATA_HOME/tdm/
            fi
          - ./tdm_installer.linux64 && rm *.exe *.ico
      - type: file
        path: com.thedarkmod.tdm.png
      - type: file
        path: com.thedarkmod.tdm.installer.png
      - type: file
        path: com.thedarkmod.tdm.desktop
      - type: file
        path: com.thedarkmod.tdm.metainfo.xml
      - type: archive
        url: https://update.thedarkmod.com/zipsync/tdm_installer.linux64.zip
        dest-filename: tdm.zip
        sha256: 56754940823a49d07bd63efcba88a4f58ecd52cc0b3d244c49fdc996f37a687d
    build-commands:
      - install -Dm 755 -t /app/bin/ tdm_installer.linux64
      - install -Dm 755 -t /app/bin/ ${FLATPAK_ID}.installer.sh
      - install -Dm 755 -t /app/bin/ ${FLATPAK_ID}.sh
      - install -Dm 644 -t /app/share/icons/hicolor/256x256/apps/ ${FLATPAK_ID}.png
      - install -Dm 644 -t /app/share/icons/hicolor/256x256/apps/ ${FLATPAK_ID}.installer.png
      - install -Dm 644 -t /app/share/applications/ ${FLATPAK_ID}.desktop
      - install -Dm 644 ${FLATPAK_ID}.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
