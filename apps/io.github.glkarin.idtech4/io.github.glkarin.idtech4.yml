app-id: io.github.glkarin.idtech4
runtime: org.freedesktop.Platform
runtime-version: &runtime-version '25.08'
sdk: org.freedesktop.Sdk
command: io.github.glkarin.idtech4.sh

finish-args:
  # hardware 3D
  - --device=all
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # Audio
  - --socket=pulseaudio

sdk-extensions:
  - org.freedesktop.Sdk.Extension.llvm20

cleanup:
  - /include
  - /lib/pkgconfig
  - /lib/cmake
  - '*.a'
  - '*.la'

modules:
  - name: miniz
    buildsystem: cmake-ninja
    config-opts:
      - -DBUILD_EXAMPLES=OFF
      - -DBUILD_TESTS=OFF
      - -DINSTALL_PROJECT=ON
    sources:
      - type: archive
        url: https://github.com/richgel999/miniz/archive/refs/tags/3.1.1.zip
        sha256: 5d09f82bcd0a4f65d1480f9e91fee0521cab729dc79606c5540c9af75ed6a006
        x-checker-data:
          type: anitya
          project-id: 8067
          url-template: https://github.com/richgel999/miniz/archive/refs/tags/$version.zip

  - name: idtech4
    builddir: true
    buildsystem: cmake-ninja
    build-options:
      append-path: /usr/lib/sdk/llvm20/bin
      prepend-ld-library-path: /usr/lib/sdk/llvm20/lib
    subdir: doom3/neo
    config-opts:
      - -DCMAKE_C_COMPILER=clang
      - -DCMAKE_CXX_COMPILER=clang++
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
      - -DCMAKE_POLICY_VERSION_MINIMUM=3.5
      - -DUSE_MINIZ=ON
      - -DDEDICATED=ON
      - -DUSE_SYSTEM_CURL=OFF
      - -DUSE_SYSTEM_OGGVORBIS=ON
      - -DUSE_SYSTEM_FREETYPE=ON
      # Doom 3
      - -DBUILD_D3=ON
      - -DBUILD_D3_MOD=ON
      - -DD3XP=ON
      - -DD3LE=ON
      - -DCDOOM=ON
      - -DRIVENSIN=ON
      - -DHARDCORPS=ON
      - -DOVERTHINKED=ON
      - -DSABOT=ON
      - -DHEXENEOC=ON
      - -DFRAGGINGFREE=ON
      - -DLIBRECOOP=ON
      - -DLIBRECOOPXP=ON
      - -DPERFECTED=ON
      - -DPERFECTEDROE=ON
      - -DPHOBOS=ON
      # Quake 4
      - -DBUILD_Q4=ON
      - -DBUILD_Q4_MOD=ON
      - -DRAVEN=ON
      - -DRAVEN_BSE_FX=ON
      - -DQUAKE4=ON
      - -DQ4_MOD_FULL_BODY_AWARENESS=ON
      - -DQ4_MOD_BOTS=ON
      - -DHARDQORE=ON
      # Prey
      - -DBUILD_PREY=ON
    sources:
      - type: archive
        url: https://github.com/glkarin/com.n0n3m4.diii4a/archive/refs/tags/v1.1.0harmattan71.zip
        sha256: 5fe3334a906f4ce353722dc3e9ce5f2177047d05284e234d45b5d21df58c1b74
        x-checker-data:
          type: anitya
          project-id: 377943
          url-template: https://github.com/glkarin/com.n0n3m4.diii4a/archive/refs/tags/v$version.zip
      - type: patch
        path: io.github.glkarin.idtech4.freetype.patch

  - name: desktop
    buildsystem: simple
    sources:
      - type: file
        path: io.github.glkarin.idtech4.doom3.png
      - type: file
        path: io.github.glkarin.idtech4.doom3.desktop
      - type: file
        path: io.github.glkarin.idtech4.doom3.sh
      - type: file
        path: io.github.glkarin.idtech4.prey.svg
      - type: file
        path: io.github.glkarin.idtech4.prey.desktop
      - type: file
        path: io.github.glkarin.idtech4.prey.sh
      - type: file
        path: io.github.glkarin.idtech4.quake4.svg
      - type: file
        path: io.github.glkarin.idtech4.quake4.desktop
      - type: file
        path: io.github.glkarin.idtech4.quake4.sh
      - type: file
        path: io.github.glkarin.idtech4.svg
      - type: file
        path: io.github.glkarin.idtech4.desktop
      - type: file
        path: io.github.glkarin.idtech4.sh
      - type: file
        path: io.github.glkarin.idtech4.metainfo.xml
    build-commands:
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo
      - install -Dm755 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}*.sh /app/bin
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}*.svg -t /app/share/icons/hicolor/scalable/apps
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}*.png -t /app/share/icons/hicolor/256x256/apps
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}*.desktop -t /app/share/applications
