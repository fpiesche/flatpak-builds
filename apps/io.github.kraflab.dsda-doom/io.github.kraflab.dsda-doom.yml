app-id: io.github.kraflab.dsda-doom
runtime: org.kde.Platform
runtime-version: '6.7'
sdk: org.kde.Sdk
command: dsda-launcher

rename-icon: dsda-doom
rename-desktop-file: dsda-doom.desktop

finish-args:
  # gamepad support
  - --device=all
  # X11 + XShm access
  - --share=ipc
  - --socket=fallback-x11
  - --socket=wayland
  # Audio
  - --socket=pulseaudio

cleanup:
  - /include
  - '*.a'
  - '*.la'
  - /lib/cmake
  - /lib/pkgconfig
  - /share/doc
  - /share/man

modules:
  - name: libzip
    buildsystem: cmake-ninja
    config-opts:
      - -DCMAKE_INSTALL_LIBDIR=/app/lib
      - -DCMAKE_INSTALL_INCLUDEDIR=/app/include
    cleanup:
      - /bin
    sources:
      - type: archive
        url: https://libzip.org/download/libzip-1.11.4.tar.xz
        sha256: 8a247f57d1e3e6f6d11413b12a6f28a9d388de110adc0ec608d893180ed7097b
        x-checker-data:
          type: anitya
          project-id: 10649
          url-template: https://libzip.org/download/libzip-$version.tar.xz

  - ../shared-modules/glu/glu-9.json
  - ../shared-modules/libmad/libmad.json
  - name: libdumb
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -D BUILD_EXAMPLES=OFF
      - -D BUILD_ALLEGRO4=OFF
    sources:
      - type: archive
        url: https://api.github.com/repos/kode54/dumb/tarball/396caa4d31859045ccb5ef943fd430ca4026cce8
        sha256: 57738c93e42a76d94b76502464962e521eb74b669e8ac56eb23349dd4ab078c5
        dest-filename: dumb.tar.gz
        x-checker-data:
          type: json
          url: https://api.github.com/repos/kode54/dumb/branches/master
          version-query: .commit.sha
          url-query: ("https://api.github.com/repos/kode54/dumb/tarball/" + .commit.sha)
  - name: portmidi
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://api.github.com/repos/PortMidi/portmidi/tarball/v2.0.7
        dest-filename: portmidi.tar.gz
        sha256: e4851b707685e2c318646e97621014918a93daab43d483d344e6e460231da5e0
        x-checker-data:
          type: json
          url: https://api.github.com/repos/portmidi/portmidi/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .tarball_url

  - name: dsda-doom
    buildsystem: cmake-ninja
    subdir: prboom2
    builddir: true
    sources:
      - type: archive
        url: https://api.github.com/repos/kraflab/dsda-doom/tarball/v0.29.4
        dest-filename: dsda-doom.tar.gz
        sha256: 91630379edd11e00287a483653a7e558141bfa230a3b88d9ce8d539f63046d4d
        x-checker-data:
          type: json
          url: https://api.github.com/repos/kraflab/dsda-doom/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .tarball_url
      - type: file
        path: io.github.kraflab.dsda-doom.metainfo.xml
    post-install:
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/${FLATPAK_ID}.metainfo.xml -t /app/share/metainfo/
  - name: dsda-doom-launcher
    buildsystem: simple
    build-options:
      env:
        - QT_INSTALL_PREFIX=/app
    subdir: src
    sources:
      - type: archive
        url: https://api.github.com/repos/Pedro-Beirao/dsda-launcher/tarball/v1.4
        dest-filename: dsda-doom-launcher.tar.gz
        sha256: 80418d7e8eb69fd91a9ecf575e5e9d89e453fb18194d1bf5785847b709310390
        x-checker-data:
          type: json
          url: https://api.github.com/repos/Pedro-Beirao/dsda-launcher/releases/latest
          version-query: .tag_name | sub("^v"; "")
          url-query: .tarball_url
      - type: patch
        path: dsda-launcher-ui.patch
      - type: patch
        path: dsda-launcher-disable-updates.patch
      - type: file
        url: https://raw.githubusercontent.com/Pedro-Beirao/dsda-launcher/refs/heads/master/src/icons/dsda-launcher.svg
        sha256: b354bcc022f55d72dd0450fe44997175e5c2b41cd8684a3a5c3b851b1b289fcd
    build-commands:
      - mkdir build && cd build && qmake ..
      - cd build && make
      - install -Dm755 build/dsda-launcher -t /app/bin
      - desktop-file-edit --set-icon=${FLATPAK_ID}.launcher icons/dsda-Launcher.desktop
      - desktop-file-edit --set-key=Comment --set-value="Graphical launcher for DSDA
        Doom" icons/dsda-Launcher.desktop
      - install -Dm644 icons/dsda-Launcher.desktop /app/share/applications/${FLATPAK_ID}.launcher.desktop
      - install -Dm644 ${FLATPAK_BUILDER_BUILDDIR}/dsda-launcher.svg /app/share/icons/hicolor/scalable/apps/${FLATPAK_ID}.launcher.svg
